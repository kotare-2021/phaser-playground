<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser-arcade-physics.min.js"></script>
</head>
<body>

  <script>

    let CollisionLayer, BackgroundLayer, SheepLayer, StarLayer, sheeps, car, stars, scoreText, carPosX, dude, carPosY, carVelX, carVelY, starText, startActive, gameActive, endActive, gameOver
    let hit = false
    let score = 0
    
// start screen

let Start = new Phaser.Class({
    Extends: Phaser.Scene,

    initialize: 
    
    function start () { Phaser.Scene.call(this, { key: 'start', active: true })},

    preload: function () {
        // this.load.audio('shutup', 'assets/sounds/shutup.mp3')
    },

    create: function () {
        let text = this.add.text(300, 200, 'SPACE TO START', { fontSize: '32px', fill: '#ffffff' });
        var camera = this.cameras.main;
        camera.setBackgroundColor('#b13543')

        this.input.keyboard.once('keydown-SPACE', () => {
            this.cameras.main.fadeOut(100, 255, 255, 255)
        })
        this.cameras.main.once(Phaser.Cameras.Scene2D.Events.FADE_OUT_COMPLETE, (cam, effect) => {
            // this.sound.play('shutup')
            this.scene.start('sceneB')
            gameActive = true
        })
    },

    update: function () {

    }
}) 


// city/star screen

let SceneB = new Phaser.Class({
  Extends: Phaser.Scene,

  initialize: 

  function sceneB () { Phaser.Scene.call(this, { key: 'sceneB', active: false })},

  preload: function () {
    this.load.tilemapTiledJSON('NewMap', 'assets/NewMap.json');
    this.load.image("terrain2", "assets/terrain2.png")
    // this.load.image("roadNE", "assets/maps/roadNE.png")
    this.load.image('star', 'assets/star.png')
    this.load.spritesheet('bomb', 
      'assets/drone.png',
      { frameWidth: 26, frameHeight: 20 }
    );
    this.load.spritesheet('dude', 
      'assets/betty.png',
      { frameWidth: 48, frameHeight: 48 }
    );
  },

  create: function () {
      // this.time.addEvent({
      //     delay: 28500,
      //     loop: false,
      //     callback: () => {
      //         this.cameras.main.fadeOut(100, 255, 255, 255)
      //     }
      // })

      // this.cameras.main.once(Phaser.Cameras.Scene2D.Events.FADE_OUT_COMPLETE, (cam, effect) => {
      //     // this.sound.play('engine')
      //     playerVelocity = 600
      //     playerPosX = player.body.position.x,
      //     playerPosY = player.body.position.y,
      //     playerVelX = player.body.velocity.x,
      //     playerVelY = player.body.velocity.y
      //     this.scene.start('sceneB')
      // })
    this.physics.world.setBounds(60, 60, 1540, 1156);
    
    const map = this.make.tilemap({key: 'NewMap'});  
    console.log(map) 
    const tileset = map.addTilesetImage('terrain2', 'terrain2')
    
    BackgroundLayer = map.createLayer('water', tileset)
    CollisionLayer = map.createLayer('Tile Layer 1', tileset)
    player = this.physics.add.sprite(395, 250, 'dude');
    this.physics.add.collider(player, CollisionLayer);
    
    
    player.setBounce(0);
    player.setCollideWorldBounds(true);
    player.body.setGravityY(0)
    player.setSize(20, 20, true)
    player.setScale(1.5)

    this.anims.create({
      key: 'left',
      frames: this.anims.generateFrameNumbers('dude', { frames: [ 1, 5, 9, 13 ] }),
      frameRate: 10,
      repeat: -1
    });
    this.anims.create({
      key: 'right',
      frames: this.anims.generateFrameNumbers('dude', { frames: [ 3, 7, 11, 15 ] }),
      frameRate: 10,
      repeat: -1
    });
    this.anims.create({
      key: 'up',
      frames: this.anims.generateFrameNumbers('dude', { frames: [ 2, 6, 10, 14 ] }),
      frameRate: 10,
      repeat: -1
    });
    this.anims.create({
      key: 'down',
      frames: this.anims.generateFrameNumbers('dude', { frames: [ 0, 4, 8, 12 ] }),
      frameRate: 10,
      repeat: -1
    });
    
    this.anims.create({
      key: 'turn',
      frames: [ { key: 'dude', frame: 0 } ],
      frameRate: 20
    })
    
    cursors = this.input.keyboard.createCursorKeys();

    stars = this.physics.add.group()
    
    map.setCollisionBetween(0, 923, true, 'Tile Layer 1')
    // this.physics.add.collider(dude, CollisionLayer)

    this.cameras.main.setBounds(0, 0, 1600, 1216);

    this.cameras.main.startFollow(player);
    
    player.setCollideWorldBounds(true);

    stars = this.physics.add.group({
      key: 'star',
      repeat: 9,
      setXY: { 
        x: 80, y: 70,
        stepX: 150, stepY: 100 },
    });
      
    bombs = this.physics.add.group();

    bombs.enableBody = true;

    this.physics.add.collider(bombs, CollisionLayer);

    this.physics.add.collider(player, bombs, hitBomb, null, this);

    function hitBomb (player, bomb) {
      this.physics.pause();
      
      player.setTint(0xff0000);
      
      player.anims.play('turn');

      gameOver = true;

      if(gameOver = true) {
        this.cameras.main.fadeOut(100, 255, 255, 255)
      }
      this.cameras.main.once(Phaser.Cameras.Scene2D.Events.FADE_OUT_COMPLETE, (cam, effect) => {
        // this.sound.play('shutup')
        this.scene.start('end')
        endActive = true
      })
    }

    stars.children.iterateLocal('setSize', 100, 100, true)

    this.physics.add.collider(stars, CollisionLayer);

    this.physics.add.overlap(player, stars, collectStar, null, this);
      
    function collectStar (player, star) {
      if (gameActive) {
        console.log('firing')
        star.disableBody(true, true);
      
        score += 10;
        scoreText.setText('Score: ' + score);
      
      if (stars.countActive(true) === 0) {
        stars.children.iterate(function (child) {
          child.enableBody(true, child.x, Phaser.Math.FloatBetween(80, 1200), true, true);
        });
        
        var x = (player.x < 400) ? Phaser.Math.Between(400, 800) : Phaser.Math.Between(0, 400);
        
        var bomb = bombs.create(x, Phaser.Math.FloatBetween(80, 1200), 'bomb');
        
        this.anims.create({
          key: 'fly',
          frames: this.anims.generateFrameNumbers('bomb', { frames: [ 0, 1, 2, 3 ] }),
          frameRate: 10,
          repeat: -1
        });

        bomb.anims.play('fly')

        bomb.setBounce(1);

        bomb.setCollideWorldBounds(true);

        bomb.setVelocity(Phaser.Math.Between(-200, 200), Phaser.Math.Between(-200, 200) ); 
      }}
    }

    scoreText = this.add.text(16, 16, 'Score: 0', { fontSize: '32px', fill: '#000' });
    scoreText.setScrollFactor(0)

    // function hitStar (dude, star) {
    //     this.sound.play('ding')
    //     star.destroy()
    //     score += 10;
    //     scoreText.setText('Score: ' + score);
    // }
  },

  update: function () {

    if (gameActive) {
      if (cursors.left.isDown)
        {
          player.setVelocityX(-160);
          
          player.anims.play('left', true);
        }
        else if (cursors.right.isDown)
        {
          player.setVelocityX(160);
          
          player.anims.play('right', true);
        }
        else if (cursors.up.isDown)
        {
          player.setVelocityY(-160);
          
          player.anims.play('up', true);
        }
        else if (cursors.down.isDown)
        {
          player.setVelocityY(160);
          
          player.anims.play('down', true);
        }
        else
        {
          player.setVelocityX(0);
          player.setVelocityY(0);
          
          player.anims.play('turn');
        } 
    }
  }
})

let end = new Phaser.Class({
    Extends: Phaser.Scene,

    initialize:
    
    function end () { Phaser.Scene.call(this, { key: 'end', active: false })},

    preload: function () {
        // this.load.audio('shutup', 'assets/sounds/shutup.mp3')
    },

    create: function () {
        let text = this.add.text(300, 100, 'YOU LOSE!', { fontSize: '32px', fill: '#ffffff' });
        this.add.text(300, 200, `Your final Score was: ${score}`, { fontSize: '24px', fill: '#ffffff' });
        this.add.text(300, 300, 'press space to restart', { fontSize: '24px', fill: '#ffffff' });
        var camera = this.cameras.main;
        camera.setBackgroundColor('#000000')

        if (endActive){ this.input.keyboard.once('keydown-SPACE', () => {
            this.cameras.main.fadeOut(100, 255, 255, 255)
        })
        this.cameras.main.once(Phaser.Cameras.Scene2D.Events.FADE_OUT_COMPLETE, (cam, effect) => {
            // this.sound.play('shutup')
            score = 0
            this.scene.start('start')
        })}
    },

    update: function () {

    }
  }) 

var config = {
        type: Phaser.AUTO,
        width: 800,
        height: 576,
        audio: {
            disableWebAudio: true
        },
        physics: {
            default: 'arcade',
            arcade: {
                debug: false
            }
        },
        scene: [SceneB, end, Start]
    };

    var game = new Phaser.Game(config);

  </script>

</body>
</html>